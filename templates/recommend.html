<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Recommendations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .score-breakdown {
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .progress {
            height: 8px;
        }
        .hybrid-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .explain-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-film"></i> Hybrid Movie Recommender
            </a>
            <div>
                <a href="{{ url_for('my_ratings') }}" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-list-stars"></i> My Ratings
                </a>
                <a href="{{ url_for('browse_movies') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-collection"></i> Browse Movies
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="text-center mb-4">
            <h1 class="display-5">
                <i class="bi bi-stars text-warning"></i> Your Personalized Recommendations!
            </h1>
            <p class="lead text-muted">Based on the movies you rated, we think you'll enjoy these.</p>
            <div class="alert alert-info">
                <small>
                    <strong>How it works:</strong> We combine user behavior patterns (70%) with movie content features like genres (30%) to give you the best recommendations.
                </small>
            </div>
        </div>

        {% if recommendations %}
            <div class="row">
                {% for rec in recommendations %}
                {% set collab_percent = (rec.collaborative_score / 5.0 * 100) | round(1) %}
                {% set content_percent = (rec.content_score / 5.0 * 100) | round(1) %}
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ rec.title }}</h5>
                            <p class="text-muted small mb-3">
                                <i class="bi bi-tags"></i> {{ rec.genres }}
                            </p>

                            <!-- Hybrid Score -->
                            <div class="mb-2">
                                <span class="badge hybrid-badge text-white fs-6">
                                    Hybrid Score: {{ rec.hybrid_score }} <i class="bi bi-star-fill"></i>
                                </span>
                            </div>

                            <!-- Score Breakdown -->
                            <div class="score-breakdown">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted">
                                            <i class="bi bi-people"></i> Collaborative (70%)
                                        </span>
                                        <span class="badge bg-primary">{{ rec.collaborative_score }}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                             style="width: {{ collab_percent }}%">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted">
                                            <i class="bi bi-bookmark"></i> Content-Based (30%)
                                        </span>
                                        <span class="badge bg-success">{{ rec.content_score }}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ content_percent }}%">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Why This Button -->
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-info w-100"
                                        onclick="explainMovie({{ rec.movieId }})">
                                    <i class="bi bi-info-circle"></i> Why was this recommended?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-danger text-center">
                <i class="bi bi-exclamation-triangle"></i>
                Sorry, we couldn't generate recommendations based on your ratings. Try rating a few more movies.
            </div>
        {% endif %}

        <div class="text-center mt-4">
            <a href="{{ url_for('browse_movies') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Rate More Movies
            </a>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div class="modal fade" id="explainModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-lightbulb"></i> Why This Recommendation?
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading explanation...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let explainModal;

        document.addEventListener('DOMContentLoaded', function() {
            explainModal = new bootstrap.Modal(document.getElementById('explainModal'));
        });

        function explainMovie(movieId) {
            document.getElementById('modalContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Analyzing recommendation...</p>
                </div>
            `;
            explainModal.show();

            fetch('/explain/' + movieId)
                .then(response => response.json())
                .then(data => {
                    displayExplanation(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('modalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Error loading explanation. Please try again.
                        </div>
                    `;
                });
        }

        function displayExplanation(data) {
            const collabPercent = (data.collaborative_score / 5) * 100;
            const contentPercent = (data.content_score / 5) * 100;

            let scoreColor = 'bg-success';
            if (data.hybrid_score < 3) scoreColor = 'bg-danger';
            else if (data.hybrid_score < 4) scoreColor = 'bg-warning';

            const content = `
                <div class="text-center mb-4">
                    <h4 class="mb-3">${data.title}</h4>
                    <p class="text-muted">
                        <i class="bi bi-tags"></i> ${data.genres}
                    </p>

                    <div class="score-circle ${scoreColor} my-3">
                        ${data.hybrid_score}
                    </div>
                    <p class="text-muted">Overall Recommendation Score</p>
                </div>

                <div class="explain-section">
                    <h6 class="mb-3">
                        <i class="bi bi-bar-chart"></i> Score Breakdown
                    </h6>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong><i class="bi bi-people-fill text-primary"></i> Collaborative Filtering</strong>
                                <br>
                                <small class="text-muted">Based on users with similar taste</small>
                            </div>
                            <span class="badge bg-primary fs-6">${data.collaborative_score} / 5.0</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary"
                                 role="progressbar"
                                 style="width: ${collabPercent}%"
                                 aria-valuenow="${collabPercent}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                ${data.collaborative_weight * 100}% weight
                            </div>
                        </div>
                        <small class="text-muted">
                            Users who rated movies similarly to you gave this movie an average rating of ${data.collaborative_score}.
                        </small>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong><i class="bi bi-bookmark-fill text-success"></i> Content-Based Filtering</strong>
                                <br>
                                <small class="text-muted">Based on movie features (genres)</small>
                            </div>
                            <span class="badge bg-success fs-6">${data.content_score} / 5.0</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success"
                                 role="progressbar"
                                 style="width: ${contentPercent}%"
                                 aria-valuenow="${contentPercent}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                ${data.content_weight * 100}% weight
                            </div>
                        </div>
                        <small class="text-muted">
                            This movie's genres match your preferences with a score of ${data.content_score}.
                        </small>
                    </div>

                    <div class="alert alert-light border">
                        <strong><i class="bi bi-calculator"></i> Calculation:</strong><br>
                        <code>
                            Hybrid Score = (${data.collaborative_weight} × ${data.collaborative_score}) + (${data.content_weight} × ${data.content_score})
                            <br>
                            = ${(data.collaborative_weight * data.collaborative_score).toFixed(2)} + ${(data.content_weight * data.content_score).toFixed(2)}
                            <br>
                            = <strong>${data.hybrid_score}</strong>
                        </code>
                    </div>
                </div>

                <div class="mt-3 p-3 bg-light border-start border-5 border-info">
                    <strong><i class="bi bi-chat-left-quote text-info"></i> In Simple Terms:</strong>
                    <p class="mb-0 mt-2">
                        ${getInterpretation(data)}
                    </p>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = content;
        }

        function getInterpretation(data) {
            let text = 'We recommended "' + data.title + '" because ';

            if (data.collaborative_score > data.content_score) {
                text += '<strong>users with similar taste to yours</strong> really enjoyed it (' + data.collaborative_score + '/5.0). ';
            } else {
                text += 'its <strong>genres closely match</strong> the types of movies you\'ve rated highly (' + data.content_score + '/5.0). ';
            }

            if (data.hybrid_score >= 4.5) {
                text += 'This is a <strong class="text-success">highly confident</strong> recommendation!';
            } else if (data.hybrid_score >= 4.0) {
                text += 'We\'re <strong class="text-primary">quite confident</strong> you\'ll enjoy this.';
            } else if (data.hybrid_score >= 3.5) {
                text += 'We think you\'ll <strong>probably like</strong> this movie.';
            } else {
                text += 'This might be worth exploring if you\'re feeling adventurous.';
            }

            return text;
        }
    </script>
</body>
</html>
